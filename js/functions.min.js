const displayAttributes=property=>{const boroughs=property.geoid.split(", ").map(getBorough);property.borough=[...new Set(boroughs)].join(", "),d3.selectAll(".attr-list .attr-blank").classed("d-none",!0).classed("d-block",!1),$(".attr-list li").remove();for(const key in property){const[attribute,value]=renameProperty(key,property[key]);if(!["_uid_","gid","gi_incon","gi_plan","gi_count","calls_311_flood","calls_311_odor","bounds"].includes(key)){const id="attr-"+key.split("_").join("-");$(".attr-list").append($("<li>").attr("prop",id).addClass(["list-group-item","p-0","bg-light"]).css("border","none").append($("<h6>").addClass(["font-weight-bold","mb-0"]).text(attribute),$("<h6>").addClass(["pl-2","pt-0","mt-0","attr-value"]).text(value)))}}$(".attr-list").each((function(i,e){$(this).children('li[prop="attr-neighborhood"]').remove().insertBefore($(this).children('li[prop="attr-geoid"]')),$(this).children('li[prop="attr-borough"]').remove().insertBefore($(this).children('li[prop="attr-geoid"]'))}))},onEachNTAFeature=(feature,layer)=>{const prop="neighborhood";layer.on({mouseover:e=>{highlightFeature(e),displayPopup(e,prop)},mouseout:e=>{resetToDefault(e),removePopup(e)},mousemove:movePopup,click:e=>{const target=e.target,properties=target.feature.properties,gid=target.feature.properties.gid,bounds=target.getBounds(),padding=[90,40];selectAndZoom(properties,gid,bounds,padding)}})},displayPopup=(e,prop)=>{const target=e.target,feature=target.feature,property="sewershed"===prop?getSewershed(feature.properties[prop]):"neighborhood"===prop?feature.properties[prop].split(/-(?![a-z])|,\s*/).sort().join(",<br>"):"treatment_plant"===prop?capitalize(feature.properties[prop]):"sewer_type"===prop?capitalize(getSewerType(feature.properties[prop])):feature.properties[prop],attribute="neighborhood"===prop?"Neighborhood(s)":capitalize(prop),popupContent=`<h6><strong>${attribute}:</strong><br>${property}</h6>`;target.bindPopup(popupContent,{autoPan:!1,closeButton:!1,interactive:!1,className:"popup-custom"}).openPopup(e.latlng)},removePopup=e=>{const target=e.target;target.closePopup()},movePopup=e=>{const target=e.target;target.openPopup(e.latlng)},highlightFeature=e=>{const target=e.target,gid=target.feature.properties.gid;gidArray.includes(gid)?highlightSelected(null,target.feature.properties):target.setStyle(myStyle.highlight)},resetToDefault=e=>{const target=e.target,gid=target.feature.properties.gid,geoid=target.feature.properties.geoid,stylePrev=target.defaultOptions.style(target.feature);geoidArray.map(d=>d.geoid).includes(geoid)||(gidArray.includes(gid)?unhighlightSelected(null,target.feature.properties):target.setStyle(stylePrev))},selectAndZoom=(props,gid,bounds,pad,scroll=!0)=>{gidArray.length>1&&gidArray.includes(gid)?leaveHighlight(null,props,scroll):gidArray.includes(gid)?(clearNTAs(),zoomToBounds(defaultBounds),ntaLayerGroup.eachLayer(layer=>{layer.eachLayer(i=>{i.feature.properties.gid===gid&&selectedLayerGroup.removeLayer(i)})})):(clearNTAs(),selectNTA(gid),highlightLeftPanel(gid,"rgba(126, 186, 73, 0.3)",scroll),displayAttributes(props),zoomToBounds(bounds,pad),createPies([props])),$(".leaflet-draw-edit-remove").removeClass("leaflet-disabled").prop("title","Delete selection")},zoomToBounds=(bounds,pad=[0,0])=>{if($("#sidebar").hasClass("collapsed"))myMap.fitBounds(bounds,{padding:pad});else{const zoom=Math.min(18,Math.max(11,myMap.getBoundsZoom(bounds,!1,pad))),sidebarWidth=$(".leaflet-sidebar-pane").width()-36;let center=L.CRS.Simple.latLngToPoint(bounds.getCenter(),zoom);center.x+=sidebarWidth,center=L.CRS.Simple.pointToLatLng(center,zoom),myMap.setView(center,zoom)}},selectNTA=gid=>{ntaLayerGroup.eachLayer(layer=>{layer.eachLayer(i=>{i.feature.properties.gid===gid&&selectedLayerGroup.addLayer(i.setStyle(myStyle.selected))})}),gidArray.push(gid)},highlightLeftPanel=(gid,color,scroll)=>{$(`[gid="${gid}"]`).css("background-color",color),scroll&&$(`[gid="${gid}"]`)[0].scrollIntoView({block:"center"})},clearNTAs=()=>{$(".list-group-item").css("background-color",""),$(".attr-list li").remove(),d3.selectAll(".attr-list .attr-blank").classed("d-block",!0),selectedLayerGroup.clearLayers(),gidArray.length=0,geoidArray.length=0,ntaLayerGroup.eachLayer(layer=>{layer.resetStyle()}),drawnItems.clearLayers(),d3.selectAll(".charts-blank, .pie-blank").classed("d-block",!0),d3.selectAll(".charts-container, .pie-container").selectAll("svg, h5, p").remove(),$(".leaflet-draw-edit-remove").addClass("leaflet-disabled").prop("title","No selections to delete")},onEachSewershed=(feature,layer)=>{const prop="sewershed";layer.on({mouseover:e=>{displayPopup(e,prop)},mouseout:e=>{removePopup(e)},mousemove:movePopup})},onEachTP=(feature,layer)=>{const prop="treatment_plant";layer.on({mouseover:e=>{displayPopup(e,prop)},mouseout:e=>{removePopup(e)},mousemove:movePopup})},onEachSewerArea=(feature,layer)=>{const prop="sewer_type";layer.on({mouseover:e=>{displayPopup(e,prop)},mouseout:e=>{removePopup(e)},mousemove:movePopup})},capitalize=s=>(s=s.toLowerCase()).split(/[\s_]+/).map(w=>w.charAt(0).toUpperCase()+w.substring(1)).join(" "),renameProperty=(prop,value)=>{let area1,area2;switch(prop){case"geoid":attribute="Neighorhood Tabulation Area (NTA) Code(s)";break;case"neighborhood":attribute="Neighborhood(s)",value=value.split(/-(?![a-z])|,\s*/).sort().join(", ");break;case"population":attribute=capitalize(prop),value=value.toLocaleString("en");break;case"gi_con":attribute="Number of Constructed Green Infrastructures",value=value.toLocaleString("en");break;case"gi_count":attribute="Number of Green Infrastructures By Construction Status",value=value.toLocaleString("en");break;case"gi_area":attribute="Combined Green Infrastructure Area",area1=Math.round(value).toLocaleString("en"),area2=(value/43560).toLocaleString("en",{minimumFractionDigits:2,maximumFractionDigits:2}),value=`${area1} sqft || ${area2} acres`;break;case"pervious_pct":attribute="Percentage of Pervious Surface Area",value=(100*value).toFixed(2)+"%";break;case"impervious_pct":attribute="Percentage of Impervious Surface Area",value=(100*value).toFixed(2)+"%";break;case"calls_311":attribute=`311 Calls in ${year-1} Related to Sewer/Sewage Incidents`,value=value.toLocaleString("en");break;case"csa_pct":attribute="Percent Area With a Combined Sewer System",value=(100*value).toFixed(2)+"%";break;case"sewershed":attribute="Major Sewershed(s)",sewershed=value.split(", ").map(getSewershed).join(", "),value=sewershed+` (${value})`;break;case"area":attribute="NTA Area",area1=Math.round(value).toLocaleString("en"),area2=(value/43560).toLocaleString("en",{minimumFractionDigits:2,maximumFractionDigits:2}),value=`${area1} sqft || ${area2} acres`;break;case"borough":attribute="Borough(s)";break;default:attribute=capitalize(prop)}return[attribute,value]},getBorough=ntaCode=>{switch(ntaCode.substring(0,2)){case"BK":return"Brooklyn";case"BX":return"Bronx";case"MN":return"Manhattan";case"QN":return"Queens";case"SI":return"Staten Island";default:return""}},getSewershed=abbr=>{switch(abbr){case"26W":return"26th Ward";case"BB":return"Bowery Bay";case"CI":return"Coney Island";case"HP":return"Hunts Point";case"JAM":return"Jamaica";case"NC":return"Newtown Creek";case"NR":return"North River";case"OB":return"Oakwood Beach";case"OH":return"Owls Head";case"PR":return"Port Richmond";case"RH":return"Red Hook";case"ROC":return"Rockaway";case"TI":return"Tallman Island";case"WI":return"Wards Island";default:return""}},getSewerType=sewer=>"OTHER"===sewer||"UNKNOWN"===sewer||null===sewer?"Other / Unknown":sewer,getCategory=status=>{switch(status){case"gi_con":return"Constructed";case"gi_incon":return"In Construction";case"gi_plan":return"Designed";case"calls_311_flood":return"Clogged/Flooding";case"calls_311_odor":return"Sewer Odor";default:return status}},selectMultiple=layer=>{const selectedFeatures=findWithin(layer);if(0===selectedFeatures.length)return;const selectedAttr=createAttrObj(selectedFeatures);combineProperties(selectedAttr),createStackedBar(selectedAttr,["gi_con","gi_incon","gi_plan"],"gi_count"),createStackedBar(selectedAttr,["calls_311_flood","calls_311_odor"],"calls_311"),createChart(selectedAttr,"population"),createPies(selectedAttr)},findWithin=layer=>{let drawnGJSON=layer.toGeoJSON();if(clearNTAs(),drawnItems.addLayer(layer),"Point"===turf.getType(drawnGJSON)){const radius=layer._mRadius/1e3,center=drawnGJSON.geometry.coordinates;drawnGJSON=turf.circle(center,radius,{units:"kilometers"})}return ntaCSA.eachLayer(polygon=>{const features=(polygon=turf.flatten(polygon.toGeoJSON())).features,len=features.length;let counter=0;for(let i=0;i<len;i++)turf.booleanWithin(features[i],drawnGJSON)&&counter++;if(counter===len){const gid=features[0].properties.gid;selectNTA(gid),highlightLeftPanel(gid,"rgba(126, 186, 73, 0.3)",!0)}}),selectedLayerGroup.getLayers().length&&zoomToBounds(selectedLayerGroup.getBounds(),[90,40]),gidArray},createAttrObj=arr=>{const objArr=[];return arr.forEach(gid=>{ntaCSA.eachLayer(layer=>{const properties=layer.feature.properties;properties.gid===gid&&objArr.push(properties)})}),objArr},combineProperties=arr=>{const attrObj={};for(const properties of arr)for(attr in properties){const value=properties[attr];attrObj.hasOwnProperty(attr)?attrObj[attr].push(value):attrObj[attr]=new Array}for(attr in attrObj){let value=attrObj[attr];attr.includes("pct")?attrObj[attr]=value.map((e,i)=>e*attrObj.area[i]).reduce((acc,e)=>acc+e,0)/attrObj.area.reduce((acc,e)=>acc+e,0):"string"==typeof value[0]?attrObj[attr]=[...new Set(value.sort())].join(", "):attrObj[attr]=value.reduce((acc,e)=>acc+e,0)}displayAttributes(attrObj)},highlightSelected=(e,d)=>{d3.selectAll(".svg-stack-bar").selectAll(`[geoid=${d.geoid}]`).each((function(){const newColor=d3.select(this).attr("alt-fill");d3.select(this).attr("fill",newColor)})),d3.selectAll(".svg-bar").selectAll(`[geoid=${d.geoid}]`).attr("fill","#c482b9"),d3.selectAll(".svg-bar-text").selectAll(`[geoid=${d.geoid}]`).attr("fill","#ab3397"),d3.selectAll(".tick").select("text").filter((function(){return d3.select(this).text()===d.geoid})).attr("fill","#ab3397"),d3.selectAll(".svg-arcs").selectAll(`[geoid=${d.geoid}]`).attr("stroke","black").attr("stroke-width",2),selectedLayerGroup.eachLayer(layer=>{layer.feature.properties.geoid===d.geoid&&layer.setStyle(myStyle.selectAndHighlight)})},unhighlightSelected=(e,d)=>{d3.selectAll(".svg-stack-bar").selectAll(`[geoid=${d.geoid}]`).each((function(){const prevColor=d3.select(this).attr("prev-color");d3.select(this).attr("fill",prevColor)})),d3.selectAll(".svg-bar").selectAll(`[geoid=${d.geoid}]`).attr("fill","#5175b0"),d3.selectAll(".svg-bar-text").selectAll(`[geoid=${d.geoid}]`).attr("fill","black"),d3.selectAll(".tick").select("text").filter((function(){return d3.select(this).text()===d.geoid})).attr("fill","black"),d3.selectAll(".svg-arcs").selectAll(`[geoid=${d.geoid}]`).attr("stroke","white"),selectedLayerGroup.eachLayer(layer=>{layer.feature.properties.geoid===d.geoid&&layer.setStyle(myStyle.selected)})},leaveHighlight=(e,d,scroll=!0)=>{if(geoidArray.length){if(geoidArray[0].geoid===d.geoid)return unhighlightSelected(e,d),highlightLeftPanel(d.gid,"rgba(126, 186, 73, 0.3)"),geoidArray.length=0,void $(".attr-list li .attr-value span").remove();geoidArray.forEach(e=>{unhighlightSelected(null,e),highlightLeftPanel(e.gid,"rgba(126, 186, 73, 0.3)")}),geoidArray.length=0,$(".attr-list li .attr-value span").remove()}highlightSelected(e,d),$(".attr-list li").each((i,e)=>{const propName=$(e).attr("prop").split(/-(.+)/)[1].replaceAll("-","_");d.borough=getBorough(d.geoid);const[attribute,value]="sewershed"!==propName?renameProperty(propName,d[propName]):[null,d[propName]];$(e).find(".attr-value").append($("<span>").addClass(["font-weight-bold","text-success"]).text(` [${value}]`))}),highlightLeftPanel(d.gid,"rgba(255, 204, 246, 0.6)",scroll),geoidArray.push({geoid:d.geoid,gid:d.gid})},createStackedBar=(attrObj,properties,total)=>{const data=attrObj.slice().sort((a,b)=>d3.ascending(a[total],b[total])),stack=d3.stack().keys(properties),series=stack(data).map(d=>(d.forEach(v=>v.key=d.key),d)),margin_top=0,margin_right=25,margin_bottom=30,margin_left=40,barHeight=15,height=Math.ceil(15*(data.length+.1))+margin_top+margin_bottom,width=$(window).width()>990?$("#right-container").width():$(window).width()>768?$(".leaflet-sidebar-pane").width():$(window).width()-40,x=d3.scaleLinear().domain([0,d3.max(series,d=>d3.max(d,d=>d[1]))]).range([margin_left,width-margin_right]),y=d3.scaleBand().domain(data.map(d=>d.geoid)).range([margin_top,height-margin_bottom]).padding(.1),color=d3.scaleOrdinal().domain(series.map(d=>d.key)).range(3==properties.length?["#143d59","#ffd55a","#6dd47e"]:["#efc9af","#1f8ac0"]),altColor=d3.scaleOrdinal().domain(series.map(d=>d.key)).range(3==properties.length?["#9c4f1a","#5a84ff","#d46dc3"]:["#c9afef","#afefc9"]),xAxis=g=>g.attr("transform",`translate(0, ${height-margin_bottom})`).classed("x-axis",!0).call(d3.axisBottom(x).ticks(width/80,",~r")),yAxis=g=>g.attr("transform",`translate(${margin_left}, 0)`).classed("y-axis",!0).call(d3.axisLeft(y).tickSizeOuter(0)).call(g=>g.selectAll(".domain")),format=d3.format(",~r");d3.selectAll(".charts-container .charts-blank").classed("d-none",!0).classed("d-block",!1);const title=renameProperty(total,data[0][total])[0];$(".charts-container").append($("<h5>").attr("id",`${total.replace(/_/,"-")}-title`).addClass(["text-wrap","font-weight-bold","text-center","p-0","m-0"]).text(title));const legend=d3.selectAll(".charts-container").append("div").classed("d-flex justify-content-around",!0).selectAll("legend").data(properties).enter().append("div"),p=legend.append("p").classed("m-0 d-inline",!0);p.append("span").classed("key-dot",!0).style("background",(d,i)=>{const color1=color(i),color2=altColor(i);return`linear-gradient(-45deg, ${color2} 50%, ${color1} 50%)`}).style("height","15px").style("width","15px"),p.insert("text").style("font-size","0.8em").text(d=>getCategory(d));const svg=d3.selectAll(".charts-container").append("svg").attr("id",`${total.replace(/_/,"-")}-chart`).attr("preserveAspectRatio","xMaxYMin meet").attr("viewBox",[0,0,width,height]);svg.append("g").selectAll("g").data(series).join("g").classed("svg-stack-bar",!0).attr("fill",d=>color(d.key)).selectAll("rect").data(d=>d).join("rect").attr("geoid",d=>d.data.geoid).attr("prev-color",d=>color(d.key)).attr("alt-fill",d=>altColor(d.key)).on("mouseover",(e,d)=>highlightSelected(e,d.data)).on("mouseout",(e,d)=>{geoidArray.map(d=>d.geoid).includes(d.data.geoid)||unhighlightSelected(e,d.data)}).on("click",(e,d)=>leaveHighlight(e,d.data)).attr("x",d=>x(d[0])).attr("y",d=>y(d.data.geoid)).attr("width",d=>x(d[1])-x(d[0])).attr("height",y.bandwidth()).append("svg:title").text(d=>`${d.data.neighborhood}\n${getCategory(d.key)}: ${d.data[d.key]}`);const xLabel=d3.scaleLinear().domain([0,d3.max(data,d=>d[total])]).range([margin_left,width-margin_right]),yLabel=d3.scaleBand().domain(d3.range(data.length)).rangeRound([margin_top,height-margin_bottom]).padding(.1);svg.append("g").classed("svg-bar-text",!0).attr("text-anchor","end").attr("font-family","sans-serif").attr("font-size",10).selectAll("text").data(data).join("text").on("mouseover",highlightSelected).on("mouseout",(e,d)=>{geoidArray.map(d=>d.geoid).includes(d.geoid)||unhighlightSelected(e,d)}).on("click",leaveHighlight).attr("geoid",d=>d.geoid).attr("x",d=>xLabel(d[total])).attr("y",(d,i)=>yLabel(i)+yLabel.bandwidth()/2).attr("dy","0.35em").attr("dx",4).attr("text-anchor","start").text(d=>format(d[total])).append("svg:title").text(d=>d.neighborhood),svg.append("g").call(xAxis),svg.append("g").call(yAxis),svg.selectAll(".y-axis .tick").data(data).on("mouseover",highlightSelected).on("mouseout",(e,d)=>{geoidArray.map(d=>d.geoid).includes(d.geoid)||unhighlightSelected(e,d)}).on("click",leaveHighlight).attr("geoid",d=>d.geoid).append("svg:title").text(d=>d.neighborhood)},createChart=(attrObj,property)=>{const data=attrObj.slice().sort((a,b)=>d3.ascending(a[property],b[property])),dataFormat=property.includes("pct")?".1%":",~r";d3.selectAll(".charts-container charts-blank").classed("d-none",!0).classed("d-block",!1);const title=renameProperty(property,data[0][property])[0];$(".charts-container").append($("<h5>").attr("id",`${property.replace(/_/,"-")}-title`).addClass(["text-wrap","font-weight-bold","text-center","p-0","m-0"]).text(title));const margin_top=0,margin_right=13,margin_bottom=30,margin_left=40,barHeight=15,height=Math.ceil(15*(data.length+.1))+margin_top+margin_bottom,width=$(window).width()>990?$("#right-container").width():$(window).width()>768?$(".leaflet-sidebar-pane").width():$(window).width()-40,x=d3.scaleLinear().domain([0,d3.max(data,d=>d[property])]).range([margin_left,width-margin_right]),y=d3.scaleBand().domain(d3.range(data.length)).rangeRound([margin_top,height-margin_bottom]).padding(.1),format=d3.format(dataFormat),xAxis=g=>g.attr("transform",`translate(0, ${height-margin_bottom})`).classed("x-axis",!0).call(d3.axisBottom(x).ticks(width/80,dataFormat.includes("%")?".0%":dataFormat)),yAxis=g=>g.attr("transform",`translate(${margin_left}, 0)`).classed("y-axis",!0).call(d3.axisLeft(y).tickFormat(i=>data[i].geoid).tickSizeOuter(0)),svg=d3.selectAll(".charts-container").append("svg").attr("id",`${property.replace(/_/,"-")}-chart`).attr("preserveAspectRatio","xMaxYMin meet").attr("viewBox",[0,0,width,height]);svg.append("g").classed("svg-bar",!0).attr("fill","#5175b0").selectAll("rect").data(data).join("rect").attr("geoid",d=>d.geoid).on("mouseover",highlightSelected).on("mouseout",(e,d)=>{geoidArray.map(d=>d.geoid).includes(d.geoid)||unhighlightSelected(e,d)}).on("click",leaveHighlight).attr("x",x(0)).attr("y",(d,i)=>y(i)).attr("width",d=>x(d[property])-x(0)).attr("height",y.bandwidth()).append("svg:title").text(d=>d.neighborhood),svg.append("g").attr("fill","white").attr("text-anchor","end").attr("font-family","sans-serif").attr("font-size",10).selectAll("text").data(data).join("text").on("mouseover",highlightSelected).on("mouseout",(e,d)=>{geoidArray.map(d=>d.geoid).includes(d.geoid)||unhighlightSelected(e,d)}).on("click",leaveHighlight).attr("geoid",d=>d.geoid).attr("x",d=>x(d[property])).attr("y",(d,i)=>y(i)+y.bandwidth()/2).attr("dy","0.35em").attr("dx",-4).text(d=>format(d[property])).call(text=>text.filter(d=>x(d[property])-x(0)<50).attr("dx",4).attr("fill","black").attr("text-anchor","start")).append("svg:title").text(d=>d.neighborhood),svg.append("g").call(xAxis),svg.append("g").call(yAxis),svg.selectAll(".y-axis .tick").data(data).on("mouseover",highlightSelected).on("mouseout",(e,d)=>{geoidArray.map(d=>d.geoid).includes(d.geoid)||unhighlightSelected(e,d)}).on("click",leaveHighlight).attr("geoid",d=>d.geoid).append("svg:title").text(d=>d.neighborhood)},createPies=attrArray=>{const data=attrArray.sort((a,b)=>a.geoid>b.geoid?1:-1);let title=`Impervious Surface Area of ${attrArray[0].neighborhood.split(/-|,\s*/).sort().join(", ").replace(/, ([^,]*)$/," & $1")}`;const margin=10,height=width=$(window).width()>990?$("#right-container").width():$(window).width()>768?$(".leaflet-sidebar-pane").width():$(window).width()-40,radius=Math.min(width-20,height-20)/2,color=d3.scaleOrdinal().domain(data.map(d=>d.name)).range(["maroon","olivedrab"]),pervData=[{name:"pervious_pct",value:d3.sum(data,d=>d.pervious_pct*d.area),dataset:data},{name:"impervious_pct",value:d3.sum(data,d=>d.impervious_pct*d.area),dataset:data}],pie=d3.pie().value(d=>d.value),arc=d3.arc().innerRadius(0).outerRadius(radius),arcs=pie(pervData),arcLabel=d3.arc().innerRadius(.6*radius).outerRadius(.6*radius);d3.selectAll(".pie-container .pie-blank").classed("d-none",!0).classed("d-block",!1),d3.selectAll(".pie-container").selectAll("svg, h5, h6").remove();const svg=d3.selectAll(".pie-container").append("svg").classed("perv-pie",!0).attr("preserveAspectRatio","xMaxYMin meet").attr("viewBox",[-width/2,-height/2,width,height]);svg.append("g").attr("stroke","white").attr("stroke-width",5).selectAll("path").data(arcs).join("path").attr("prop",d=>d.data.name).attr("d",arc).attr("fill",d=>color(d.data.name)).append("svg:title").text(d=>capitalize(d.data.name.split("_")[0])),svg.append("g").attr("font-family","sans-serif").attr("font-size","1.2em").attr("text-anchor","middle").selectAll("text").data(arcs).join("text").attr("fill","white").attr("transform",d=>`translate(${arcLabel.centroid(d)})`).call(text=>text.append("tspan").attr("y","-0.4em").attr("font-weight","bold").text(d=>capitalize(d.data.name.split("_")[0])).append("svg:title").text(d=>capitalize(d.data.name.split("_")[0]))).call(text=>text.filter(d=>d.endAngle-d.startAngle>.25).append("tspan").attr("x",0).attr("y","0.8em").attr("fill-opacity",.8).text(d=>(d.data.value/43560).toFixed(0).toLocaleString("en")+" acres").append("svg:title").text(d=>capitalize(d.data.name.split("_")[0]))),attrArray.length>1&&(d3.selectAll(".pie-container path").on("mouseover",(e,d)=>{d3.select(e.target).attr("opacity",.7),d3.select(e.target).style("cursor","pointer")}).on("mouseout",(e,d)=>{d3.select(e.target).attr("opacity",1),d3.select(e.target).style("cursor","pointer")}).on("click",drillDown),d3.selectAll(".pie-container text").on("mouseover",(e,d)=>{d3.selectAll(".perv-pie").selectAll(`[prop=${d.data.name}]`).attr("opacity",.7),d3.select(e.target).style("cursor","pointer")}).on("mouseout",(e,d)=>{d3.selectAll(".perv-pie").selectAll(`[prop=${d.data.name}]`).attr("opacity",1),d3.select(e.target).style("cursor","pointer")}).on("click",drillDown),$(".pie-container").append($("<h6>").attr("id","ratio-title").addClass(["text-wrap","text-center","p-0","m-0"]).text("Select a sector to drill down and reveal additional data.")),title="Impervious Surface Area of Selected NTAs"),$(".pie-container").prepend($("<h5>").attr("id","ratio-title").addClass(["text-wrap","font-weight-bold","text-center","p-0","m-0"]).text(title))},drillDown=(e,d)=>{const data=d.data.dataset,value=d.data.name,margin=10,height=width=$(window).width()>990?$("#right-container").width():$(window).width()>768?$(".leaflet-sidebar-pane").width():$(window).width()-40,radius=Math.min(width-20,height-20)/2,color="impervious_pct"===value?d3.scaleSequential().domain([0,data.length]).interpolator(d3.interpolateSpectral):d3.scaleSequential().domain([data.length,0]).interpolator(d3.interpolateSpectral),pie=d3.pie().value(d=>d[value]),arc=d3.arc().innerRadius(radius-width/8).outerRadius(radius).padAngle(d=>1).padRadius(2).cornerRadius(5),arcs=pie(data),arcLabel=d3.arc().innerRadius(.87*radius).outerRadius(.87*radius);d3.selectAll(".pie-container").selectAll("svg, h5, h6").remove(),$(".pie-container").append($("<h5>").attr("id","ratio-title").addClass(["text-wrap","font-weight-bold","text-center","p-0","m-0"]).text(`Percentage of ${d3.select(e.target).select("title").text()} Surfaces for Selected NTAs`));const svg=d3.selectAll(".pie-container").append("svg").attr("preserveAspectRatio","xMaxYMin meet").attr("viewBox",[-width/2,-height/2,width,height]);svg.append("g").classed("svg-arcs",!0).attr("stroke","white").selectAll("path").data(arcs).join("path").on("mouseover",(e,d)=>highlightSelected(null,d.data)).on("mouseout",(e,d)=>{geoidArray.map(d=>d.geoid).includes(d.data.geoid)||unhighlightSelected(null,d.data)}).on("click",(e,d)=>leaveHighlight(null,d.data)).attr("geoid",d=>d.data.geoid).attr("d",arc).attr("fill",d=>color(d.index)).attr("stroke",d=>{if(geoidArray.map(d=>d.geoid).includes(d.data.geoid))return"black"}).attr("stroke-width",d=>{if(geoidArray.map(d=>d.geoid).includes(d.data.geoid))return 2}).append("svg:title").text(d=>d.data.neighborhood),svg.append("g").attr("font-family","sans-serif").attr("font-size","0.8em").classed("shadow-stroke",!0).selectAll("text").data(arcs).join("text").on("mouseover",(e,d)=>highlightSelected(null,d.data)).on("mouseout",(e,d)=>{geoidArray.map(d=>d.geoid).includes(d.data.geoid)||unhighlightSelected(null,d.data)}).on("click",(e,d)=>leaveHighlight(null,d.data)).attr("transform",(function(d){const midAngle=d.endAngle<Math.PI?d.startAngle/2+d.endAngle/2:d.startAngle/2+d.endAngle/2+Math.PI;return"translate("+arcLabel.centroid(d)[0]+","+arcLabel.centroid(d)[1]+") rotate(-90) rotate("+180*midAngle/Math.PI+")"})).attr("dy",".35em").attr("text-anchor","middle").text(d=>data.length<=40?d3.format(".1%")(d.data[value]):null).append("svg:title").text(d=>d.data.neighborhood);const circle=d3.selectAll(".pie-container svg").append("g");circle.append("circle").on("mouseover",e=>{d3.select(e.target).attr("opacity",.7),d3.select(e.target).style("cursor","pointer")}).on("mouseout",e=>d3.select(e.target).attr("opacity",1)).on("click",e=>createPies(data)).attr("cx",0).attr("cy",0).attr("r",radius-width/6).attr("fill","pervious_pct"===value?"olivedrab":"maroon"),$(".pie-container").append($("<h6>").attr("id","ratio-title").addClass(["text-wrap","text-center","p-0","m-0"]).text("Click center circle to go back up.")).append($("<h6>").attr("id","ratio-title").css("font-size","0.9em").addClass(["text-wrap","text-center","p-0","m-0"]).html(`For percentage labels to show, select 40 or fewer NTAs.\n        <br/>(${data.length} currently selected)`))};